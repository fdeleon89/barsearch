<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Directory Search</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #323130;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #0078d4;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .file-upload {
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-wrapper {
            display: inline-block;
            position: relative;
            overflow: hidden;
            background-color: #0078d4;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .file-input-wrapper:hover {
            background-color: #106ebe;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .search-container {
            margin-bottom: 30px;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e1e1;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .search-box:focus {
            outline: none;
            border-color: #0078d4;
        }

        .results-container {
            min-height: 100px;
        }

        .result-item {
            background-color: #f3f2f1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #0078d4;
            transition: background-color 0.2s;
        }

        .result-item:hover {
            background-color: #edebe9;
        }

        .branch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e1e1;
        }

        .branch-name {
            font-weight: 700;
            font-size: 18px;
            color: #0078d4;
        }

        .branch-code {
            background-color: #0078d4;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .phone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .phone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #e1e1e1;
        }

        .phone-label {
            font-weight: 600;
            color: #605e5c;
            font-size: 14px;
        }

        .phone-number {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #323130;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .extensions-section {
            margin-bottom: 15px;
        }

        .flota-section {
            margin-bottom: 15px;
        }

        .directo-section {
            margin-bottom: 0;
        }

        .section-title {
            font-weight: 700;
            color: #323130;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #605e5c;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #0078d4;
        }

        .error {
            background-color: #fdf2f2;
            color: #d13438;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #d13438;
        }

        .success {
            background-color: #f2f9f2;
            color: #107c10;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #107c10;
        }

        .instruction {
            background-color: #fff4ce;
            color: #8a8886;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #ffb900;
        }

        .search-hint {
            font-size: 12px;
            color: #605e5c;
            text-align: center;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .branch-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .phone-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Branch Directory Search</h1>
        
        <div class="instruction" id="instruction">
            Please upload your Excel file containing branch information to get started.
        </div>

        <div class="file-upload">
            <label class="file-input-wrapper">
                Choose Excel File
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </label>
        </div>

        <div class="search-container" id="searchContainer" style="display: none;">
            <input 
                type="text" 
                id="searchBox" 
                class="search-box" 
                placeholder="üîç Search by Branch Code or Branch Name..." 
                autocomplete="off"
            />
            <div class="search-hint">Type branch code (e.g., "001") or branch name (e.g., "Central Office") to search</div>
        </div>

        <div class="results-container" id="resultsContainer"></div>
    </div>

    <script>
        let branchData = [];
        let allData = [];

        const phoneColumns = [
            { key: 'extensions', label: 'Extensions', section: 'extensions' },
            { key: 'ext2', label: 'Ext 2', section: 'extensions' },
            { key: 'ext3', label: 'Ext 3', section: 'extensions' },
            { key: 'flotaGerencia', label: 'Flota Gerencia', section: 'flota' },
            { key: 'flota1', label: 'Flota 1', section: 'flota' },
            { key: 'flota2', label: 'Flota 2', section: 'flota' },
            { key: 'directo1', label: 'Directo 1', section: 'directo' },
            { key: 'directo2', label: 'Directo 2', section: 'directo' }
        ];

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('searchBox').addEventListener('input', handleSearch);

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="loading">üìä Loading Excel file...</div>';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        throw new Error('Excel file must contain at least a header row and one data row');
                    }

                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);
                    
                    // Find column indices
                    const columnIndices = findColumnIndices(headers);
                    validateRequiredColumns(columnIndices);

                    // Extract and clean the data
                    branchData = dataRows
                        .filter(row => row[columnIndices.branchCode] && row[columnIndices.branchName])
                        .map(row => createBranchObject(row, columnIndices));

                    allData = [...branchData];

                    if (branchData.length === 0) {
                        throw new Error('No valid data found in the Excel file');
                    }

                    // Show success message and enable search
                    document.getElementById('instruction').style.display = 'none';
                    document.getElementById('searchContainer').style.display = 'block';
                    resultsContainer.innerHTML = `<div class="success">‚úÖ Successfully loaded ${branchData.length} branch records. Start typing to search!</div>`;
                    
                    // Show all results initially
                    setTimeout(() => {
                        displayResults(branchData);
                    }, 1000);

                } catch (error) {
                    resultsContainer.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                }
            };

            reader.onerror = function() {
                resultsContainer.innerHTML = '<div class="error">‚ùå Error reading file. Please try again.</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        function findColumnIndices(headers) {
            const indices = {};
            
            headers.forEach((header, index) => {
                const headerLower = String(header).toLowerCase().trim().replace(/\s+/g, '');
                
                if (headerLower.includes('branchcode') || headerLower === 'codigo') {
                    indices.branchCode = index;
                } else if (headerLower.includes('branchname') || (headerLower.includes('branch') && headerLower.includes('name')) || headerLower === 'sucursal') {
                    indices.branchName = index;
                } else if (headerLower === 'extensions' || headerLower === 'extension') {
                    indices.extensions = index;
                } else if (headerLower === 'ext2' || headerLower === 'ext 2') {
                    indices.ext2 = index;
                } else if (headerLower === 'ext3' || headerLower === 'ext 3') {
                    indices.ext3 = index;
                } else if (headerLower.includes('flotagerencia') || headerLower === 'flota gerencia') {
                    indices.flotaGerencia = index;
                } else if (headerLower === 'flota1' || headerLower === 'flota 1') {
                    indices.flota1 = index;
                } else if (headerLower === 'flota2' || headerLower === 'flota 2') {
                    indices.flota2 = index;
                } else if (headerLower === 'directo1' || headerLower === 'directo 1') {
                    indices.directo1 = index;
                } else if (headerLower === 'directo2' || headerLower === 'directo 2') {
                    indices.directo2 = index;
                }
            });
            
            return indices;
        }

        function validateRequiredColumns(indices) {
            if (indices.branchCode === undefined) {
                throw new Error('Could not find "BranchCode" column. Please ensure your Excel file has this column header.');
            }
            if (indices.branchName === undefined) {
                throw new Error('Could not find "Branch Name" column. Please ensure your Excel file has this column header.');
            }
        }

        function createBranchObject(row, indices) {
            return {
                branchCode: String(row[indices.branchCode] || '').trim(),
                branchName: String(row[indices.branchName] || '').trim(),
                extensions: String(row[indices.extensions] || '').trim(),
                ext2: String(row[indices.ext2] || '').trim(),
                ext3: String(row[indices.ext3] || '').trim(),
                flotaGerencia: String(row[indices.flotaGerencia] || '').trim(),
                flota1: String(row[indices.flota1] || '').trim(),
                flota2: String(row[indices.flota2] || '').trim(),
                directo1: String(row[indices.directo1] || '').trim(),
                directo2: String(row[indices.directo2] || '').trim()
            };
        }

        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayResults(allData);
                return;
            }

            const filteredData = allData.filter(item => 
                item.branchCode.toLowerCase().includes(searchTerm) ||
                item.branchName.toLowerCase().includes(searchTerm)
            );

            displayResults(filteredData);
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (data.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">üîç No branches found matching your search.</div>';
                return;
            }

            const resultsHTML = data.map(item => createResultHTML(item)).join('');
            resultsContainer.innerHTML = resultsHTML;
        }

        function createResultHTML(item) {
            const extensionsPhones = phoneColumns.filter(col => col.section === 'extensions' && item[col.key]);
            const flotaPhones = phoneColumns.filter(col => col.section === 'flota' && item[col.key]);
            const directoPhones = phoneColumns.filter(col => col.section === 'directo' && item[col.key]);

            return `
                <div class="result-item">
                    <div class="branch-header">
                        <div class="branch-name">${escapeHtml(item.branchName)}</div>
                        <div class="branch-code">${escapeHtml(item.branchCode)}</div>
                    </div>
                    
                    ${extensionsPhones.length > 0 ? `
                        <div class="extensions-section">
                            <div class="section-title">üìû Extensions</div>
                            <div class="phone-grid">
                                ${extensionsPhones.map(col => `
                                    <div class="phone-item">
                                        <span class="phone-label">${col.label}</span>
                                        <span class="phone-number">${escapeHtml(item[col.key])}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${flotaPhones.length > 0 ? `
                        <div class="flota-section">
                            <div class="section-title">üöó Flota Numbers</div>
                            <div class="phone-grid">
                                ${flotaPhones.map(col => `
                                    <div class="phone-item">
                                        <span class="phone-label">${col.label}</span>
                                        <span class="phone-number">${escapeHtml(item[col.key])}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${directoPhones.length > 0 ? `
                        <div class="directo-section">
                            <div class="section-title">‚òéÔ∏è Direct Lines</div>
                            <div class="phone-grid">
                                ${directoPhones.map(col => `
                                    <div class="phone-item">
                                        <span class="phone-label">${col.label}</span>
                                        <span class="phone-number">${escapeHtml(item[col.key])}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show initial instruction
        document.getElementById('resultsContainer').innerHTML = '<div class="no-results">üëÜ Please upload an Excel file to begin searching</div>';
    </script>
</body>
</html>